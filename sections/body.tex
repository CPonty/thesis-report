\mainmatter

% =====================================================================

\chapter{Introduction}

A block diagram is a model of a system in which components or functions are represented by blocks, and relationships or connections between them by connecting lines. Block diagram models of engineering systems are heavily used by designers and educators in many fields, including hardware design, electronics design, software engineering, control systems and others.
\\

Sketching block diagrams (or block diagram equivalent designs) on a static surface (such as paper or a whiteboard) is a common part of the design process for engineering students, educators and professionals. Often the system being designed is subsequently analysed and simulated using a computer aided tool, requiring the sketched design to be manually reconstructed on a computer. It should be possible to reduce or eliminate this delay between sketch and simulation and thus increase productivity for system designers using an automated, computer aided process.
\\

Today there are plenty of available systems capable of handwriting recognition for various engineering designs. However, these are generally specialised for taking input from a stylus or touchscreen, and/or recognition of symbols and designs for a specific engineering domain.
\\

\textit{BlocSim}\footnote{BlocSim - http://www.github.com/CPonty/BlocSim} is a proof-of-concept for a sketch-to-simulation solution capable of servicing a broad range of engineering domains. Its role is to visually capture a sketch of a block-diagram-like model and update external simulation tools with an adapted model in real-time. 
\\

An open-source prototype of BlocSim shall be built which achieves this functionality for simple whiteboard sketches. BlocSim will be built with extensibility in mind, as expanding its ability to interface with third-party software will require updates over time.


\begin{comment}

\end{comment}

% =====================================================================

\chapter{Background}



\section{Block Diagrams in Engineering}



\begin{figure}[ht!]
\includegraphics[width=70mm]{images/blockDiagram.png}
\hspace{0.5 cm}
\includegraphics[width=50mm]{images/circuitDiagram2.png} \\
\includegraphics[width=50mm]{images/controlSystem.png} 
\hspace{0.5 cm}
\includegraphics[width=50mm]{images/fbd.jpg} 
\centering
\caption{Block diagram (top left) \cite{wiringDiagrams}, circuit diagram (top right) \cite{engineeronadisk}, control system block diagram (bottom left) \cite{engineeronadisk}, function block diagram (bottom right) \cite{wikicommonsFbd}}
\label{im:blockExample}
\end{figure}

%\clearpage



\subsection{LTSpice}



\begin{figure}[ht!]
\centering
\includegraphics[width=50mm]{images/ltspice1.png}
\includegraphics[width=50mm]{images/ltspice2.png}
\caption{Simple LTSpice circuit with corresponding netlist file \cite{ltspice}}
\label{im:ltspice}
\end{figure}

\clearpage

%\cite{ltspice}



\section{Block Diagram Sketch Capture}



\subsection{Engineering Sketch Recognition \& Simulation}


\begin{figure}[ht!]
\centering
\includegraphics[width=75mm]{images/sketchInterpSoftware.jpg}
\caption{Recognition of stylus-drawn electrical circuit components \cite{sketchInterpSoftware}}
\label{im:sketchInterpSoftware}
\end{figure}

\clearpage

\subsubsection{QuickDiagram}



\subsection{Electronic Whiteboards}



\subsection{Block Component Identification}

%\cite{sketchInterpSoftware}
%\cite{quickDiagram}
%\cite{quickDiagramDemo}
%\cite{interactiveWhiteboards}
%\cite{interactiveWhiteboards2}
%\cite{panasonic}
%\cite{ledLcd}
%\cite{handDrawnCircuits}
%\cite{artag}
%\cite{bestFiducial}
%\cite{artoolkit}
%\cite{ltspice}


%\cite{fiducial}
%\cite{fiducialAR}
% G. Schall et al
%\cite{colorFiducial}
% H. Bagherinia et al

\begin{figure}[ht!]
\centering
\includegraphics[width=50mm]{images/fiducialPic.jpg}
\caption{Example of fiducials present on a \gls{pcb} \cite{fiducialPic}}
\label{im:fiducialPic}
\end{figure}

\clearpage



\subsubsection{Frame Markers}
\label{ch:back:borders}


%TODO

\begin{figure}[ht!]
\centering
\includegraphics[width=50mm]{images/frameMarker.png}
\caption{Vuforia Frame Marker fiducial example \cite{vuforia}}
\label{im:frameMarker}
\end{figure}

\clearpage

%\cite{vuforia}


% =====================================================================

\section{Open Source Software}

A key benefit of writing free and open source software (FOSS) comes from creating opportunity for others to contribute to a project. However, this requires the developers to create an environment suitable for collaboration, which involves more than simply writing nicely formatted \& documented code.
\\

\subsection{Contributors}

Contributions to an active open-source project come from many contributor roles. Aside from \textit{developers} writing and documenting code, there should be \textit{testers} actively using and testing the project, people providing \textit{user support} by answering questions (e.g. on a forum), \textit{bug reporters} and regular \textit{users}. Any one contributor can fill several roles. A final and important role are the project's \textit{observers}, who may be considering becoming contributors.

Clearly all of these roles are important ones. Therefore, it is beneficial to setup infrastructure to support all of them. This can include, but is not limited to:
\begin{description}
	\item[Ease of Access] - providing a convenient means for users to acquire \& run the software
	\item[Project Monitoring] - keeping all roles informed with the status of the project, such as the roles of developers, changesets, project direction
	\item[User Support] - providing a means for users to learn about the project, seek help with issues and contact developers
	\item[Issue Tracking] - providing a means for users and developers to create and monitor bug reports or suggestions for new features. This functionality is at the core of open source development
	\item[Centralised source control] - ensure developers have a central 'source of truth', with the ability to effectively manage distributed development and merge work
\end{description}

Taking steps to support contributors is a key to success for all open source projects. \cite{openSource2}. 

\textit{GitHub}\footnote{GitHub - \url{https://www.github.com/}} is a highly valuable and widely used online space for open source software projects. It provides a \textit{Git}\footnote{Git - \url{http://www.git-scm.com/}} version control system, facilitating branches of development and the ability to rollback/merge changes, a wiki page for documentation, release management and an issue tracker.

\vspace{0.5 cm}

\subsection{Software Evaluation \& Selection}

Selection of existing software, libraries and tools for use in a project must be carefully considered. Often there exists a wide range of possible off-the-shelf components which can fill a given requirement, and each must be evaluated on its merits to the project. Evaluation can involve, but is not limited to, researching views and opinions from the open source community and reading source code and documentation. Selection criteria are broad, and may include source code quality, documentation quality and completeness, maturity, stability, cross-platform support, ease of use \& maintenance, and importantly the permissiveness of its licensing. \cite{openSource}
\\

Given that BlocSim's key functionality requires converting block models to be compatible with a variety of third party software, it will require maintenance and ongoing work over time. A FOSS model will serve the project well.

% =====================================================================


\section{Computer Vision Software}

As BlocSim's core functionality involves interpreting hand-drawn sketches, it will require the ability to perform image processing on a captured sketch.

\subsection{Computer Vision Frameworks}

A large number of free, off-the-shelf image processing and computer vision libraries are available to this project. In order to minimise time required to implement the BlocSim prototype, evaulation of options focuses on frameworks I have previous experience with. Two such frameworks were evaluated for this project: Mathworks' \textit{Computer Vision System toolbox} \cite{matlab} and the OpenCV Foundation's \textit{Open Source Computer Vision Library} (OpenCV) \cite{opencv}.
\\

In terms of performance, OpenCV has a strong advantage over most freely available frameworks.
Its stated purpose is to "provide a common infrastructure for computer vision applications and to accelerate the use of machine perception" \cite{opencv}. OpenCV began its life as a project in Intel's labs, which resulted in Intel's Integrated Performance Primitives (IPP), which include assembly routines for computer vision optimised by hand \cite{opencvBook}. While OpenCV APIs are available for several languages including Java and python, the core functionality is written in compiled, optimised C++. For these reasons, OpenCV generally outperforms other freely available open source libraries \cite{opencvBench}.
\\

Working in Matlab offers different advantages. Matlab's Computer Vision System toolbox actually integrates the OpenCV library into Matlab, allowing access to Matlab's convenient visualisation and data processing capabilities, higher levels of abstraction and an extended image processing library \cite{matlabCV}. However, working with Matlab would present several problems:

\begin{itemize}
\item Matlab is commercial software with considerable purchase cost, which would erode the project's open-source value
\item As a large software package running in a Java virtual machine, Matlab's performance does not match that of utilising OpenCV directly
\item Writing features of BlocSim outside of computer vision will be more convenient in a standalone program than executing in a data analysis tool
\end{itemize}

\begin{figure}[ht!]
\centering
\includegraphics[width=25mm]{images/OpenCVlogo.png}
\caption{The OpenCV Logo \cite{opencv}}
\label{im:cvlogo}
\end{figure}

\subsection{Techniques}


%select OpenCV; discuss useful features it has with footnotes
% colour thresholding
% contour heirarchy
% adaptive thresholding

%\cite{matlab}
%\cite{opencvBench}
%%\cite{opencvBook}



% =====================================================================

\chapter{BlocSim Specification}
\label{ch:spec}



\section{Solution Concept}

\begin{figure}[ht!]
\centering
\includegraphics[width=150mm]{images/BlocsimBD1.jpg}
\caption{BlocSim System Design \cite{blocsimPoster}}
\label{im:BlocsimBD1}
\end{figure}

\clearpage



\section{Block Diagram Capture}



\subsection{Fiducial Design}


%TODO


\begin{figure}[ht!]
\centering
\includegraphics[width=100mm]{images/BlocsimBloc1.jpg}
\caption{BlocSim Block Diagram format (sketch)}
\label{im:BlocsimBD1}
\end{figure}

\begin{figure}[ht!]
\centering
\includegraphics[width=100mm]{images/BlocsimBloc2.jpg}
\caption{BlocSim Block Diagram format (model)}
\label{im:BlocsimBD2}
\end{figure}

\begin{figure}[ht!]
\centering
\includegraphics[width=100mm]{images/BlocsimBloc3.jpg}
\caption{BlocSim Block Diagram format (block types A,B,C,D mapped to Digital Logic gates)}
\label{im:BlocsimBD3}
\end{figure}

\clearpage



\subsection{Computer Vision Requirements}


%TODO


%\newpage

\section{Technology Selection}

\begin{table}[ht!]
	\center
	\begin{tabular}{$r^l} %$
		\hline
		\rowstyle{\bfseries}
		Component & Selected Technology \\
		\hline \\
		Primary Programming Language & \textbf{Python} \footnotemark[1] \\
		Computer Vision Package & \textbf{OpenCV} \footnotemark[2] \\
		Human Interface & Web control panel \\
		Web Framework & \textbf{Tornado} \footnotemark[3] \\
		Communication/Storage Format & \textbf{\gls{json}} \footnotemark[4] \\
		Remote Access & \textbf{JSON-RPC} \footnotemark[5] protocol via \textbf{TornadoRPC} \footnotemark[6] \\
		Client-Server Communication & \textbf{Websockets} \footnotemark[7], using \textbf{SockJS} \footnotemark[8] \& \textbf{SockJS-Tornado} \footnotemark[9] \\
		Block Diagram Publishing & \textbf{Mosquitto} \footnotemark[10] Publish/Subscribe Broker \\
		\\
		\hline
	\end{tabular}
	\caption{Selection of technologies for the BlocSim prototype}
	\label{tab:techSelect}
\end{table} 



%TODO



%\cite{facebookTornado}
%\cite{socketioBugs}
%\footnotemark[11]
%\footnotemark[12]
%\footnotemark[13]
%\footnotemark[14]
\footnotetext[1]{Python - \url{https://www.python.org/}}
\footnotetext[2]{OpenCV - \url{http://opencv.org/}} 
\footnotetext[3]{Tornado - \url{http://www.tornadoweb.org/en/stable/}}
\footnotetext[4]{JSON - \url{http://json.org/}}
\footnotetext[5]{JSON-RPC - \url{http://json-rpc.org/wiki/specification}}
\footnotetext[6]{TornadoRPC - \url{https://github.com/joshmarshall/tornadorpc}}
\footnotetext[7]{Websockets - \url{http://www.websocket.org/}}
\footnotetext[8]{SockJS - \url{https://github.com/sockjs/sockjs-client}}
\footnotetext[9]{SockJS-Tornado - \url{https://github.com/mrjoes/sockjs-tornado}}
\footnotetext[10]{Mosquitto - \url{http://mosquitto.org/}}
\footnotetext[11]{Flask - \url{http://flask.pocoo.org/}}
\footnotetext[12]{Socket.io - \url{http://socket.io/}}
\footnotetext[13]{Redis - \url{http://redis.io/}}
\footnotetext[14]{Meteor - \url{https://www.meteor.com/}}

\clearpage

% =====================================================================

\section{Open-Source Delivery}

The BlocSim source, release build, issue tracking and documentation are to be publicly hosted online at GitHub \cite{blocsim}\cite{github}. Having a centralised, publicly visible location for these services and material provides both exposure for the project and valuable support infrastructure for any future work on the project (by its original author or others) which may take place. 

Additionally, every effort has been made to select only free and open source libraries and dependencies, making the project more accessible to developers.

BlocSim is to be licensed under GPLv2 \cite{gplv2}, a permissive license which guarantees freedom to share and change the software, appropriate for encouraging and facilitating open source development.
\\


% =====================================================================

\chapter{Implementation}

%TODO

\begin{figure}[ht!]
\centering
\includegraphics[width=50mm]{images/BlocsimLogo.png}
\caption{The BlocSim Logo \cite{blocsim}}
\label{im:blocsimlogo}
\end{figure}

\clearpage



\begin{figure}[ht!]
\centering
\includegraphics[width=125mm]{images/photo2.jpg}
\caption{Camera and whiteboard demonstration setup}
\label{im:hardware1}
\end{figure}

\begin{figure}[ht!]
\centering
\includegraphics[width=75mm]{images/photo3.jpg}
\includegraphics[width=85mm]{images/photo4.jpg}
\caption{Logitech C920HD 1080p Camera; close-up of block diagram on whiteboard}
\label{im:hardware2}
\end{figure}

\clearpage


\section{Features \& Usage}

%TODO

\begin{figure}[ht!]
\centering
\includegraphics[width=150mm]{images/screenshot_cv1.png}
\caption{The BlocSim Web Control Panel \cite{blocsim}}
\label{im:screenshot_cv1}
\end{figure}

\begin{figure}[ht!]
\centering
\includegraphics[width=150mm]{images/screenshot_calib.png}
\caption{BlocSim Control Panel - calibration sliders \cite{blocsim}}
\label{im:screenshot_calib}
\end{figure}

\begin{figure}[ht!]
\centering
\includegraphics[width=150mm]{images/screenshot_pubsub.png}
\caption{BlocSim Control Panel - Block Diagram model \cite{blocsim}}
\label{im:screenshot_pubsub}
\end{figure}

\begin{figure}[ht!]
\centering
\includegraphics[width=150mm]{images/screenshot_rpc.png}
\caption{BlocSim Control Panel - Remote Procedure Call server status \cite{blocsim}}
\label{im:screenshot_rpc}
\end{figure}

\clearpage



\begin{figure}[ht!]
\centering
\includegraphics[width=125mm]{images/frame1.jpg}
\caption{BlocSim output image (1) - cropped frame \cite{blocsim}}
\label{im:frame1}
\end{figure}

\begin{figure}[ht!]
\centering
\includegraphics[width=125mm]{images/frame3.jpg}
\caption{BlocSim output image (3) - red \cite{blocsim}}
\label{im:frame3}
\end{figure}

\begin{figure}[ht!]
\centering
\includegraphics[width=125mm]{images/frame4.jpg}
\caption{BlocSim output image (4) - red block \cite{blocsim}}
\label{im:frame4}
\end{figure}

\begin{figure}[ht!]
\centering
\includegraphics[width=125mm]{images/frame8.jpg}
\caption{BlocSim output image (8) - block ID \cite{blocsim}}
\label{im:frame8}
\end{figure}

\begin{figure}[ht!]
\centering
\includegraphics[width=125mm]{images/frame12.jpg}
\caption{BlocSim output image (12) - connector lines (mask) \cite{blocsim}}
\label{im:frame12}
\end{figure}

\begin{figure}[ht!]
\centering
\includegraphics[width=125mm]{images/frame13.jpg}
\caption{BlocSim output image (13) - connection nodes \cite{blocsim}}
\label{im:frame13}
\end{figure}

\begin{figure}[ht!]
\centering
\includegraphics[width=125mm]{images/frame15.jpg}
\caption{BlocSim output image (15) - block diagram overlay \cite{blocsim}}
\label{im:frame15}
\end{figure}

\begin{figure}[ht!]
\centering
\includegraphics[width=125mm]{images/frame16.jpg}
\caption{BlocSim output image (16) - block model \cite{blocsim}}
\label{im:frame16}
\end{figure}

\clearpage



\newpage
\begin{figure}[ht!]
	\fontsize{8pt}{8pt}
	\singlespacing
	\begin{mdframed}
		\verbinput{images/example.json}
	\end{mdframed}
	\caption{Sample of JSON Block Diagram Model output (not all blocks, nodes shown)}
	\label{tab:json}
\end{figure}

\clearpage




% =====================================================================

\section{Technical Architecture}

\begin{figure}[ht!]
\centering
\includegraphics[width=170mm]{images/BlocsimBD3.jpg}
\caption{BlocSim's Architecture}
\label{im:BlocsimBD3}
\end{figure}

\begin{figure}[ht!]
\centering
\includegraphics[width=170mm]{images/BlocsimBD4.jpg}
\caption{Process flow for video stream}
\label{im:BlocsimBD4}
\end{figure}

%TODO

%\newpage
\clearpage

\noindent The Python webserver's functionality is split into several threads, including:

\begin{description}
	\item[Main Thread] - Executes the Tornado webserver IO Loop. Includes handling websockets and Remote Procedure Calls
	\item[Publish Thread] - Executes the Mosquitto client IO Loop
	\item[Capture Thread] - Reads from the camera when signalled
	\item[Webcam Thread] - Handles webcam connection/disconnection and storing frames
	\item[Processing Thread] - Uses OpenCV to generate images and the block model
	\item[Timer Thread] - Limits the webcam capture frame rate
\end{description}

\noindent These threads communicate via a series of event signallers and shared resources, such as the keystore database and image processing output.



\vspace{1 cm}

\noindent For more information, see the resources outlined in Appendix \ref{ch:appendix}.



% =====================================================================

\chapter{Project Evaluation}

%TODO


\section{Completion}

\begin{table}[ht!]
	\center
	\begin{tabular}{$p{65mm}^l^p{65mm}} %$
		\hline
		\rowstyle{\bfseries}
		Feature & Complete & Incomplete \\
		\hline
		Surface Capture & \gtick & \\
		Human interface (Control Panel) & \gtick & full UI synchronisation between multiple clients \\
		External control interface (RPC) & \gtick & \\
		Configurable (Keystore, via the above) & \gtick & More \gls{cv} settings should be user configurable \\
		Real-time Computer Vision for \newline Block Diagram recognition & \gtick & \\
		Block Diagram Model output \newline (MQTT Publish/Subscribe) & \gtick & \\
		\ldots & & \\
		Digital Logic Adapter & & \rcross \\
		Minimalist Digital Logic Simulator & & \rcross \\
		\hline
	\end{tabular}
	\caption{Feature completion for BlocSim prototype}
	\label{tab:completion}
\end{table} 

\clearpage



\section{Performance}

%TODO


\subsection{Speed \& Resource Usage}



%\subsubsection{Network}
\paragraph{Network}



%\subsubsection{CPU}
\paragraph{CPU}



%\subsubsection{Frame Rate}
\paragraph{Frame Rate}



\subsection{Computer Vision Reliability}

\begin{figure}[ht!]
\centering
\includegraphics[width=125mm]{images/frame4glow.jpg}
\caption{BlocSim output image (4) - reflections on whiteboard can result in missed block components}
\label{im:frame4glow}
\end{figure}

%TODO

\section{Design Decisions Review}

%TODO

\section{Future Improvement}

%TODO



% =====================================================================

\chapter{Conclusion}

The creation of the BlocSim prototype according to speicifications laid out in Chapter \ref{ch:spec} was generally a success. Recognition of the whiteboard block diagrams runs in real time and performs well under controlled lighting conditions, however requires some initial manual tuning according to lighting conditions and camera. Control of the system and access to the block diagram model is convenient and user friendly through both \gls{gui} and external software, although the calibration controls should be expanded and synchronisation of controls between multiple web clients completed. The planned adapter for demonstrating conversion of generic block diagram models to digital logic gate models is yet to be implemented.
\\

Work on BlocSim so far has demonstrated that computer vision based primarily on the colour of whiteboard marker features is not as reliable as is desired. Even with a high resolution image, variations in actual marker colour, thin or lightly drawn features and strong reflections from background light sources can be significant, in some cases causing the algorithm to miss image features and build an incomplete block diagram model. This issue can be partially resolved in future work by encoding the block type in black-and-white frame marker fiducials, and pre-printing them onto non-reflective magnetic cards (see Section \ref{ch:back:borders}).
\\

Overall, the current prototype is a useful but small first step towards bridging the gap between block diagram sketches and simulation software. BlocSim will require extensive future work as an open source project before it can truly be a solution to this problem.

% =====================================================================

\begin{comment}

\end{comment}
